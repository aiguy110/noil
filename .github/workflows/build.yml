name: Build

on:
  push:
    branches: ["**"]
    tags: ["v*.*.*"]
  pull_request:

jobs:
  build-modern:
    name: Build (ubuntu-latest)
    runs-on: ubuntu-latest
    steps:
      - name: Check release tag
        id: tag_check
        run: |
          is_release=false
          if [ "${GITHUB_REF_TYPE}" = "tag" ] && [[ "${GITHUB_REF_NAME}" =~ ^v[0-9]+\.[0-9]+\.[0-9]+$ ]]; then
            is_release=true
          fi
          echo "is_release=$is_release" >> "$GITHUB_OUTPUT"

      - name: Checkout
        uses: actions/checkout@v4

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Build (debug)
        if: steps.tag_check.outputs.is_release == 'false'
        run: cargo build --locked

      - name: Build (release)
        if: steps.tag_check.outputs.is_release == 'true'
        run: cargo build --locked --release

      - name: Upload artifact
        if: steps.tag_check.outputs.is_release == 'true'
        uses: actions/upload-artifact@v4
        with:
          name: noil-linux-amd64
          path: target/release/noil

  build-glibc-2-17:
    name: Build (glibc 2.17)
    runs-on: ubuntu-latest
    steps:
      - name: Check release tag
        id: tag_check
        run: |
          is_release=false
          if [ "${GITHUB_REF_TYPE}" = "tag" ] && [[ "${GITHUB_REF_NAME}" =~ ^v[0-9]+\.[0-9]+\.[0-9]+$ ]]; then
            is_release=true
          fi
          echo "is_release=$is_release" >> "$GITHUB_OUTPUT"

      - name: Checkout
        uses: actions/checkout@v4

      - name: Build (debug) in manylinux2014 container
        if: steps.tag_check.outputs.is_release == 'false'
        run: |
          docker run --rm -v "${GITHUB_WORKSPACE}:/work" -w /work quay.io/pypa/manylinux2014_x86_64 /bin/bash -lc '
            yum -y install curl gcc gcc-c++ git make openssl-devel pkgconfig
            curl https://sh.rustup.rs -sSf | sh -s -- -y --profile minimal
            source "$HOME/.cargo/env"
            rustup default stable
            export DUCKDB_PLATFORM=linux_amd64
            export DUCKDB_EXPLICIT_PLATFORM=linux_amd64
            export CPPFLAGS="-DDUCKDB_PLATFORM=\"linux_amd64\" -DDUCKDB_EXPLICIT_PLATFORM=\"linux_amd64\" -DDUCKDB_CUSTOM_PLATFORM=\"linux_amd64\""
            export CXXFLAGS="-D_GLIBCXX_USE_CXX11_ABI=1 -DDUCKDB_PLATFORM=\"linux_amd64\" -DDUCKDB_EXPLICIT_PLATFORM=\"linux_amd64\" -DDUCKDB_CUSTOM_PLATFORM=\"linux_amd64\""
            export CFLAGS="-DDUCKDB_PLATFORM=\"linux_amd64\" -DDUCKDB_EXPLICIT_PLATFORM=\"linux_amd64\" -DDUCKDB_CUSTOM_PLATFORM=\"linux_amd64\""
            cargo build --locked
          '

      - name: Build (release) in manylinux2014 container
        if: steps.tag_check.outputs.is_release == 'true'
        run: |
          docker run --rm -v "${GITHUB_WORKSPACE}:/work" -w /work quay.io/pypa/manylinux2014_x86_64 /bin/bash -lc '
            yum -y install curl gcc gcc-c++ git make openssl-devel pkgconfig
            curl https://sh.rustup.rs -sSf | sh -s -- -y --profile minimal
            source "$HOME/.cargo/env"
            rustup default stable
            export DUCKDB_PLATFORM=linux_amd64
            export DUCKDB_EXPLICIT_PLATFORM=linux_amd64
            export CPPFLAGS="-DDUCKDB_PLATFORM=\"linux_amd64\" -DDUCKDB_EXPLICIT_PLATFORM=\"linux_amd64\" -DDUCKDB_CUSTOM_PLATFORM=\"linux_amd64\""
            export CXXFLAGS="-D_GLIBCXX_USE_CXX11_ABI=1 -DDUCKDB_PLATFORM=\"linux_amd64\" -DDUCKDB_EXPLICIT_PLATFORM=\"linux_amd64\" -DDUCKDB_CUSTOM_PLATFORM=\"linux_amd64\""
            export CFLAGS="-DDUCKDB_PLATFORM=\"linux_amd64\" -DDUCKDB_EXPLICIT_PLATFORM=\"linux_amd64\" -DDUCKDB_CUSTOM_PLATFORM=\"linux_amd64\""
            cargo build --locked --release
          '

      - name: Upload artifact
        if: steps.tag_check.outputs.is_release == 'true'
        uses: actions/upload-artifact@v4
        with:
          name: noil-linux-glibc-2.17-amd64
          path: target/release/noil

  release:
    name: Release
    runs-on: ubuntu-latest
    needs: [build-modern, build-glibc-2-17]
    if: startsWith(github.ref, 'refs/tags/')
    permissions:
      contents: write
    steps:
      - name: Check release tag
        id: tag_check
        run: |
          is_release=false
          if [ "${GITHUB_REF_TYPE}" = "tag" ] && [[ "${GITHUB_REF_NAME}" =~ ^v[0-9]+\.[0-9]+\.[0-9]+$ ]]; then
            is_release=true
          fi
          echo "is_release=$is_release" >> "$GITHUB_OUTPUT"

      - name: Download artifacts
        if: steps.tag_check.outputs.is_release == 'true'
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: Create release
        if: steps.tag_check.outputs.is_release == 'true'
        uses: softprops/action-gh-release@v2
        with:
          files: |
            artifacts/noil-linux-amd64/noil
            artifacts/noil-linux-glibc-2.17-amd64/noil
