# =============================================================================
# NOIL PARENT MODE CONFIGURATION
# =============================================================================
# This configuration demonstrates a parent deployment.
# Parents pull batches from multiple collectors, perform centralized fiber
# processing, and store results in DuckDB.
#
# Use case: Run a parent instance in a central location to correlate logs
# from multiple edge collectors.

# =============================================================================
# OPERATION MODE
# =============================================================================

mode: parent

# =============================================================================
# PARENT MODE CONFIGURATION
# =============================================================================

parent:
  # Collector endpoints to pull from
  # Each collector should be running in collector mode with its HTTP API accessible
  collectors:
    - id: collector-node-1             # Unique identifier for this collector
      url: http://localhost:7105
      retry_interval: 5s          # Retry delay on connection failure
      timeout: 30s                # HTTP request timeout

  # Polling interval: how often to check collectors for new batches
  # Lower = lower end-to-end latency, higher network overhead
  # Higher = higher latency, lower network overhead
  # Recommended: 1s-5s depending on latency requirements
  poll_interval: 1s

  # Backpressure handling for parent's internal pipeline
  backpressure:
    strategy: block
    buffer_limit: 10000

# =============================================================================
# FIBER TYPES
# =============================================================================
# Define fiber correlation rules. These run on the parent after collecting
# logs from all collectors.

fiber_types:
  # Correlates requests across program1 (frontend) and program2 (backend)
  # from all collector nodes
  request_trace:
    description: "Traces requests across frontend proxy and backend service"
    temporal:
      max_gap: 5s
      gap_mode: session

    attributes:
      # MAC address - primary correlation key across both programs
      - name: mac
        type: mac
        key: true

      # Thread IDs - used while request is in flight, released after
      - name: program1_thread
        type: string
        key: true

      - name: program2_thread
        type: string
        key: true

      # Client IP and ports - captured but not used for matching
      - name: client_ip
        type: ip

      - name: client_port
        type: int

      # Backend server details
      - name: backend_ip
        type: ip

      - name: backend_port
        type: int

      # Derived attribute - connection identifier
      - name: client_connection
        type: string
        derived: "${client_ip}:${client_port}"

      # Derived attribute - backend connection
      - name: backend_connection
        type: string
        derived: "${backend_ip}:${backend_port}"

    sources:
      # Source names must match those defined in collector configs
      program1:
        patterns:
          # When a thread receives a new connection, release that thread from
          # other fibers first (prevents merging new request with old one)
          - regex: 'thread-(?P<program1_thread>\d+) Received connection from (?P<client_ip>\d+\.\d+\.\d+\.\d+):(?P<client_port>\d+)'
            release_matching_peer_keys: [program1_thread]

          # Extract MAC address and thread
          - regex: 'thread-(?P<program1_thread>\d+).*MAC (?P<mac>[0-9a-fA-F:]+)'

          # Extract backend server info
          - regex: 'thread-(?P<program1_thread>\d+) Forwarding to backend server (?P<backend_ip>\d+\.\d+\.\d+\.\d+):(?P<backend_port>\d+)'

          # Generic thread matcher (catches all other program1 thread logs)
          - regex: 'thread-(?P<program1_thread>\d+)'

      program2:
        patterns:
          # Extract MAC address and thread
          - regex: 'thread-(?P<program2_thread>\d+).*MAC (?P<mac>[0-9a-fA-F:]+)'

          # Request completion - release thread and close fiber
          - regex: 'thread-(?P<program2_thread>\d+) Request complete'
            release_self_keys: [program2_thread]
            close: true

          # Generic thread matcher
          - regex: 'thread-(?P<program2_thread>\d+)'

      nginx_access:
        patterns:
          - regex: '(?P<client_ip>[\d\.]+) - - "GET /api/devices HTTP/1.1"'

  # Groups consecutive log lines from the simple service
  simple_log:
    description: "Groups request sessions from single-threaded service"
    temporal:
      max_gap: 1s
      gap_mode: session

    attributes:
      # Static derived attribute for grouping
      - name: source_marker
        type: string
        key: true
        derived: "simple_service"

    sources:
      simple_service:
        patterns:
          # Close fiber when request ends
          - regex: 'END OF REQUEST'
            close: true

          # Match any line (ensures all logs are included)
          - regex: '.+'

# =============================================================================
# PIPELINE SETTINGS
# =============================================================================

pipeline:
  backpressure:
    strategy: block
    buffer_limit: 10000

  errors:
    on_parse_error: drop

  checkpoint:
    enabled: true
    interval_seconds: 30

# =============================================================================
# SEQUENCER SETTINGS
# =============================================================================

sequencer:
  batch_epoch_duration: 10s
  watermark_safety_margin: 1s

# =============================================================================
# STORAGE SETTINGS
# =============================================================================
# Parent stores all raw logs and fiber memberships

storage:
  path: $env{TMPDIR}/noil-parent.duckdb
  batch_size: 1000
  flush_interval_seconds: 5

# =============================================================================
# WEB SERVER SETTINGS
# =============================================================================
# The parent's web server provides the full Noil UI

web:
  listen: 0.0.0.0:7104
  # After starting, visit http://<parent-host>:7104 to view the UI
  # All logs from all collectors will be visible in the UI

# =============================================================================
# UNUSED SECTIONS (Parent Mode)
# =============================================================================
# The following sections are ignored/should not be configured in parent mode:
#   - sources: Parent gets logs from collectors, not files
#   - collector: Only needed in collector mode
#
# Note: Do NOT configure sources in parent mode. If you need to read local
# logs on the parent machine, run a collector instance locally and add it
# to the collectors list.
